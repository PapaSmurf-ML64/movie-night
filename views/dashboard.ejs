<!DOCTYPE html>
<html>
<head>
  <title>Movie Night Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    h1 { color: #333; }
    .section { margin-bottom: 2em; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>Movie Night Dashboard</h1>
  <div class="section">
    <h2>Upcoming Schedule</h2>
    <% if (allDates && allDates.length > 0) { %>
      <table>
        <tr><th>Date</th><th>Title</th><th>Added By</th><th>Actions</th></tr>
        <% function formatDate(dateStr) {
          const date = new Date(dateStr + 'T20:00:00Z');
          const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
          const day = date.getUTCDate();
          const year = date.getUTCFullYear();
          const month = months[date.getUTCMonth()];
          function ordinal(n) {
            if (n > 3 && n < 21) return n + 'th';
            switch (n % 10) {
              case 1: return n + 'st';
              case 2: return n + 'nd';
              case 3: return n + 'rd';
              default: return n + 'th';
            }
          }
          return `${month} ${ordinal(day)}, ${year}`;
        } %>
        <% allDates.forEach(dateStr => { %>
          <% const moviesForDate = dashboardByDate[dateStr] || []; %>
          <% const isSaturday = new Date(dateStr).getDay() === 6; %>
          <tr>
            <td><%= formatDate(dateStr) %> <% if (!isSaturday) { %><span style="color:#b00;font-weight:bold;">(Special Event)</span><% } %></td>
            <td>
              <% if (moviesForDate.length === 0) { %>
                &lt;empty&gt;
              <% } else { %>
                <% moviesForDate.forEach((m, idx) => { %>
                  <%= m.title %><% if (m.release_date) { %> (<%= m.release_date.slice(0,4) %>)<% } %><%= idx < moviesForDate.length - 1 ? ', ' : '' %>
                <% }) %>
              <% } %>
            </td>
            <td>
              <% if (moviesForDate.length === 0) { %>
                &ndash;
              <% } else { %>
                <% const addedById = moviesForDate[0].added_by ? moviesForDate[0].added_by.split(',')[0] : '';
                   const addedByName = userMap && userMap[addedById] ? userMap[addedById] : addedById; %>
                <%= addedByName %>
              <% } %>
            </td>
            <td>
              <% if (moviesForDate.length === 0) { %>
                &ndash;
              <% } else { %>
                <% const m = moviesForDate[0];
                   const eventId = upcoming.find(u => u.date === m.date && u.title === m.title)?.id; %>
                <% if (m.title !== '<empty>' && eventId) { %>
                  <form action="/archive/<%= eventId %>" method="post" style="display:inline" onsubmit="return confirm('Archive this event?');">
                    <button type="submit">Archive</button>
                  </form>
                  <form action="/delete-archived/<%= eventId %>" method="post" style="display:inline" onsubmit="return confirm('Delete this event?');">
                    <button type="submit">Delete</button>
                  </form>
                <% } else { %>
                  &ndash;
                <% } %>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </table>
    <% } else { %>
      <p>No movies scheduled.</p>
    <% } %>
  </div>
  <div class="section">
    <h2>Archived Events</h2>
    <input type="text" id="archivedSearch" placeholder="Search archived events..." style="margin-bottom:10px;width:100%;padding:0.5em;" onkeyup="filterArchivedEvents()">
    <% if (archived.length === 0) { %>
      <p>No archived events.</p>
    <% } else { %>
      <% // Group archived events by year %>
      <% const archivedByYear = {}; archived.forEach(e => { const y = new Date(e.date).getFullYear(); if (!archivedByYear[y]) archivedByYear[y] = []; archivedByYear[y].push(e); }); %>
      <% Object.keys(archivedByYear).sort((a,b) => b-a).forEach(year => { %>
        <div class="archived-year-group">
          <button class="collapsible" onclick="toggleYear('<%= year %>')" style="width:100%;text-align:left;padding:0.5em;font-size:1em;font-weight:bold;">▶ <%= year %> (<%= archivedByYear[year].length %>)</button>
          <div id="archived-<%= year %>" class="archived-content" style="display:none;">
            <table style="margin-bottom:1em;">
              <tr><th>Title</th><th>Date Watched</th><th>Actions</th></tr>
              <% archivedByYear[year].forEach(e => { %>
                <tr class="archived-row">
                  <td><%= e.title %><% if (e.release_date) { %> (<%= e.release_date.slice(0,4) %>)<% } %></td>
                  <td><%= e.date %></td>
                  <td>
                    <form action="/delete-archived/<%= e.id %>" method="post" style="display:inline" onsubmit="return confirm('Delete this archived event?');">
                      <button type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </table>
          </div>
        </div>
      <% }) %>
    <% } %>
    <script>
      function toggleYear(year) {
        var content = document.getElementById('archived-' + year);
        var btn = content.previousElementSibling;
        if (content.style.display === 'none') {
          content.style.display = '';
          btn.innerHTML = '▼ ' + year + ' (' + content.querySelectorAll('.archived-row').length + ')';
        } else {
          content.style.display = 'none';
          btn.innerHTML = '▶ ' + year + ' (' + content.querySelectorAll('.archived-row').length + ')';
        }
      }
      function filterArchivedEvents() {
        var input = document.getElementById('archivedSearch').value.toLowerCase();
        var yearGroups = document.querySelectorAll('.archived-year-group');
        yearGroups.forEach(function(group) {
          var rows = group.querySelectorAll('.archived-row');
          var anyVisible = false;
          rows.forEach(function(row) {
            var title = row.children[0].textContent.toLowerCase();
            if (title.indexOf(input) > -1) {
              row.style.display = '';
              anyVisible = true;
            } else {
              row.style.display = 'none';
            }
          });
          // Show year group if any row matches, else hide
          group.style.display = anyVisible ? '' : 'none';
        });
      }
    </script>
  </div>
  <div class="section">
    <h2>RSVP List</h2>
    <% if (rsvps.length === 0) { %>
      <p>No one has RSVP'd yet.</p>
    <% } else { %>
      <ul>
        <% rsvps.forEach(u => { %>
          <li>
            <% if (userMap && userMap[u]) { %>
              <%= userMap[u] %> (<%= u %>)
            <% } else { %>
              <%= u %>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
  <div class="section">
    <h2>Attendance List</h2>
    <% if (attendance.length === 0) { %>
      <p>No attendees yet.</p>
    <% } else { %>
      <ul>
        <% attendance.forEach(u => { %>
          <li>
            <% if (userMap && userMap[u]) { %>
              <%= userMap[u] %> (<%= u %>)
            <% } else { %>
              <%= u %>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</body>
</html>
